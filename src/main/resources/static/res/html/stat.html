<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>查看统计信息</title>
    <script src="../js/vue.js"></script>
    <script src="../js/axios0.18.js"></script>
    <script src="../js/pub.js"></script>
    <script src="https://cdn.staticfile.net/echarts/4.3.0/echarts.min.js"></script>
    <link type="text/css" rel="stylesheet" href="../css/stat.css">
</head>
<body>
<div id="stat1" style="width: 800px;height:400px;margin: auto"></div>
<div id="stat2" style="width: 800px;height:400px;margin: auto"></div>
<div id="stat3" style="width: 800px;height:400px;margin: auto"></div>

</body>
<script>
    new Vue({
        el: "#app",
        data: {
            pageCurrent: 1,
            pageNum: 0,
            infoList: [],
            userId: 1,
            x_data: [],
            y_data: [],
            category_list: [],
            selected: 0,
        },
        methods: {
            prePage: function () {
                let _this = this
                if (_this.pageCurrent > 1) {
                    _this.pageCurrent--
                    _this.search()
                }
            },
            nextPage: function () {
                let _this = this
                if (_this.pageCurrent < _this.pageNum) {
                    _this.pageCurrent++
                    _this.search()
                }
            },
            search: function () {
                let _this = this;
                let data = {user_id: -1, pageId: _this.pageCurrent, keyword: _this.keyword};
                axios({
                    method: "post",
                    url: "/equipment/search_all",
                    data: convertToQueryString(data)
                }).then(function (resp) {
                    console.log(resp.data);
                    if (resp.data.code == 200) {
                        _this.infoList = resp.data.data.rows
                        _this.pageNum = resp.data.data.total
                        for (let i = 0; i < _this.infoList.length; i++) {
                            console.log("i设备类别ID:" + _this.infoList[i].categoryId)
                            if (!_this.x_data.includes(_this.category_list[_this.infoList[i].categoryId - 1].name)) {
                                _this.x_data.push(_this.category_list[_this.infoList[i].categoryId - 1].name);
                                _this.y_data.push(0);
                            }
                            _this.y_data[_this.infoList[i].categoryId - 1] =
                                _this.y_data[_this.infoList[i].categoryId - 1] + 1;
                        }
                        console.log(_this.x_data)
                        console.log(_this.y_data)
                        // 基于准备好的dom，初始化echarts实例
                        let myChart = echarts.init(document.getElementById('stat1'));

                        // 指定图表的配置项和数据
                        let option = {
                            title: {
                                text: '不同类型设备数量统计'
                            },
                            tooltip: {},
                            legend: {
                                data: ['设备数量']
                            },
                            xAxis: {
                                data: _this.x_data,
                                name: '设备类型'
                            },
                            yAxis: {
                                name: '设备数量'
                            },
                            series: [{
                                name: '各类型设备数量',
                                type: 'bar',
                                data: _this.y_data
                            }]
                        };
                        // 使用刚指定的配置项和数据显示图表。
                        myChart.setOption(option);


                        _this.x_data = [];
                        _this.y_data = [];
                        let user = 0;

                        for (let i = 0; i < _this.infoList.length; i++) {
                            if (!_this.x_data.includes(_this.infoList[i].userId)) {
                                _this.x_data.push(_this.infoList[i].userId);
                                _this.y_data.push(0);
                                user += 1;
                            }
                            _this.y_data[user - 1] =
                                _this.y_data[user - 1] + 1;
                        }
                        console.log(_this.x_data)
                        console.log(_this.y_data)
                        // 基于准备好的dom，初始化echarts实例
                        let myChart2 = echarts.init(document.getElementById('stat2'));

                        // 指定图表的配置项和数据
                        let option2 = {
                            title: {
                                text: '管理员上传设备统计'
                            },
                            tooltip: {},
                            legend: {
                                data: ['管理员ID']
                            },
                            xAxis: {
                                data: _this.x_data,
                                name: '管理员ID',
                            },
                            yAxis: {
                                name: '上传设备数量',
                            },
                            series: [{
                                name: '上传设备数量',
                                type: 'bar',
                                data: _this.y_data
                            }]
                        };
                        // 使用刚指定的配置项和数据显示图表。
                        myChart2.setOption(option2);

                        _this.x_data = [];
                        _this.y_data = [];
                        user = 0;//按理讲应该命名为date，不过已经有现成的user了，就用它吧

                        for (let i = 0; i < _this.infoList.length; i++) {
                            if (!_this.x_data.includes(_this.infoList[i].date)) {
                                _this.x_data.push(_this.infoList[i].date);
                                _this.y_data.push(0);
                                user += 1;
                            }
                            _this.y_data[user - 1] =
                                _this.y_data[user - 1] + 1;
                        }
                        for (let i = 0;i<_this.x_data.length;i++){
                            let date = new Date(_this.x_data[i]);
                            // 使用getFullYear, getMonth (注意月份是从0开始的，所以要+1), 和getDate方法来获取年月日
                            let year = date.getFullYear();
                            let month = ("0" + (date.getMonth() + 1)).slice(-2); // 添加前导零
                            let day = ("0" + date.getDate()).slice(-2); // 添加前导零
                            // 格式化日期字符串
                            _this.x_data[i] = year + '年' + month + '月' + day + '日';
                        }
                        console.log(_this.x_data)
                        console.log(_this.y_data)
                        // 基于准备好的dom，初始化echarts实例
                        let myChart3 = echarts.init(document.getElementById('stat3'));

                        // 指定图表的配置项和数据
                        let option3 = {
                            title: {
                                text: '设备上传日期统计'
                            },
                            tooltip: {},
                            legend: {
                                data: ['上传日期']
                            },
                            xAxis: {
                                data: _this.x_data,
                                name: '上传日期',
                            },
                            yAxis: {
                                name: '上传设备数量',
                            },
                            series: [{
                                name: '上传设备数量',
                                type: 'bar',
                                data: _this.y_data
                            }]
                        };

                        // 使用刚指定的配置项和数据显示图表。
                        myChart3.setOption(option3);
                    } else {
                        alert(resp.data.msg);
                    }
                }).catch(function (error) {
                    console.log(error);
                })
            },
            // e_id是设备id
            getItem: function (e_id) {
                let source = "equipment.html?id=" + e_id
                window.location.href = source
            }
        },
        created() {
            let _this = this;
            let user_id = sessionStorage.getItem("user_id");
            _this.userId = user_id;
            axios({
                method: "post",
                url: "/category/getList",
            }).then(function (resp) {
                console.log(resp.data);
                if (resp.data.code == 200) {
                    _this.category_list = resp.data.data
                } else {
                    alert(resp.data.msg);
                }
            }).catch(function (error) {
                console.log(error);
            });
            console.log(_this.category_list)
            _this.search();
            console.log("初始化力！！！");
        }
    })
</script>
</html>